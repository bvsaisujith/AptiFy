{% extends 'assignments/base.html' %}

{% block title %}Quiz Section | AptiFy{% endblock %}

{% block content %}
<section class="page-shell">
    <div class="card question-card">
        <div class="question-header">
            <div class="question-meta">
                <span class="badge">Question {{ question_number }} of {{ total_questions }}</span>
                <span class="meta-separator">•</span>
                <span>Quiz Section</span>
                <span class="meta-separator">•</span>
                <span class="timer" id="quiz-timer">00:00</span>
            </div>
            <h2 class="question-title">{{ question.text }}</h2>
        </div>

        <div class="options-grid" id="options-container">
            {% for option in question.options %}
            <div class="option-card" onclick="selectOption('{{ option.id }}', this)">
                <span class="option-id">{{ option.id|upper }}.</span>
                {{ option.text }}
            </div>
            {% endfor %}
        </div>

        <div class="actions-row">
            <button id="submit-btn" class="btn btn-primary" onclick="submitAnswer()" disabled>
                Submit Answer
            </button>
        </div>
    </div>
</section>

<!-- Hidden inputs to track state -->
<input type="hidden" id="attempt-id" value="{{ attempt_id }}">
<input type="hidden" id="question-id" value="{{ question_id }}">

{% endblock %}

{% block extra_js %}
<script>
    let selectedOptionId = null;
    const quizStartTime = performance.now();
    const timerEl = document.getElementById('quiz-timer');

    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        return `${minutes}:${seconds}`;
    }

    const timerInterval = setInterval(() => {
        const elapsed = performance.now() - quizStartTime;
        if (timerEl) {
            timerEl.textContent = formatTime(elapsed);
        }
    }, 500);

    function selectOption(id, element) {
        selectedOptionId = id;

        // UI Selection
        document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
        element.classList.add('selected');

        document.getElementById('submit-btn').disabled = false;
    }

    async function submitAnswer() {
        const attemptId = document.getElementById('attempt-id').value;
        const questionId = document.getElementById('question-id').value;
        const btn = document.getElementById('submit-btn');

        if (!selectedOptionId) return;

        btn.disabled = true;
        btn.innerText = "Submitting...";

        try {
            clearInterval(timerInterval);
            const timeTakenSeconds = (performance.now() - quizStartTime) / 1000;
            const result = await AssignmentAPI.submitQuiz(
                attemptId,
                questionId,
                selectedOptionId,
                timeTakenSeconds
            );
            // Logic to move to next question.
            // For now, we assume backend directs or we request next content.
            // Simplified: Reload or Redirect to next question ID provided by backend?
            // Since we rely on Django views, we might need to redirect to the next view URL.
            // Let's assume the view handles next logic via a 'next_url' in context or we deduce it.
            // Ideally, we'd fetch the next question via API and re-render partial, but we are using Views.
            window.location.href = "{{ next_url }}";
        } catch (e) {
            console.error(e);
            alert("Submission failed.");
            btn.disabled = false;
            btn.innerText = "Submit Answer";
        }
    }
</script>
{% endblock %}