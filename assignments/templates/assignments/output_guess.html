{% extends 'assignments/base.html' %}

{% block title %}Logical Reasoning | AptiFy{% endblock %}

{% block content %}
<section class="page-shell">
    <div class="card question-card">
        <div class="question-header">
            <div class="question-meta">
                <span class="badge">Logic Section</span>
                <span class="meta-separator">â€¢</span>
                <span class="timer" id="logic-timer">00:00</span>
            </div>
            <h2 class="question-title">Predict the output of the following code:</h2>
        </div>

        <div class="code-block">
            <pre>{{ question.code_snippet }}</pre>
        </div>

        <div class="field-block">
            <label class="field-label" for="output-input">Your Output Prediction</label>
            <input type="text" id="output-input" class="input-field" placeholder="Type the exact output here...">
        </div>

        <div class="actions-row">
            <button id="submit-btn" class="btn btn-primary" onclick="submitOutput()">
                Submit Prediction
            </button>
        </div>
    </div>
</section>

<input type="hidden" id="attempt-id" value="{{ attempt_id }}">
<input type="hidden" id="question-id" value="{{ question.id }}">
{% endblock %}

{% block extra_js %}
<script>
    const logicStartTime = performance.now();
    const logicTimerEl = document.getElementById('logic-timer');

    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        return `${minutes}:${seconds}`;
    }

    const logicTimerInterval = setInterval(() => {
        const elapsed = performance.now() - logicStartTime;
        if (logicTimerEl) {
            logicTimerEl.textContent = formatTime(elapsed);
        }
    }, 500);

    async function submitOutput() {
        const attemptId = document.getElementById('attempt-id').value;
        const questionId = document.getElementById('question-id').value;
        const predicted = document.getElementById('output-input').value;
        const btn = document.getElementById('submit-btn');

        if (!predicted.trim()) {
            alert("Please enter a prediction.");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Submitting...";

        try {
            clearInterval(logicTimerInterval);
            const timeTakenSeconds = (performance.now() - logicStartTime) / 1000;
            await AssignmentAPI.submitOutput(attemptId, questionId, predicted, timeTakenSeconds);
            window.location.href = "{{ next_url }}";
        } catch (e) {
            console.error(e);
            alert("Submission failed.");
            btn.disabled = false;
        }
    }
</script>
{% endblock %}