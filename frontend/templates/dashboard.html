{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - AptiFy{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <header class="topbar">
    <div class="topbar-left">
      <a class="brand" href="/" aria-label="AptiFy home">
        <img src="{% static 'img/aptify-logo.jpg' %}" alt="AptiFy logo" width="32" height="32">
        <span>AptiFy</span>
      </a>
    </div>
    <div class="topbar-right">
      <button class="icon-button" type="button" aria-label="Notifications">ğŸ””</button>
      <div class="avatar" aria-hidden="true">{{ user.first_name|default:user.username|slice:":1" }}</div>
      <form method="post" action="{% url 'account_logout' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary btn-small">Logout</button>
      </form>
    </div>
  </header>

  <div class="dashboard-layout">
    <aside class="sidebar">
      <nav class="sidebar-nav" aria-label="Primary">
        <a href="{% url 'dashboard' %}" class="sidebar-link active">ğŸ  Dashboard</a>
        <a href="{% url 'profile' %}" class="sidebar-link">ğŸ“˜ Module 1 â€“ Profile</a>
        <a href="/assignments/" class="sidebar-link">ğŸ§ª Module 2 â€“ Assignment</a>
        <a href="{% url 'intelligence' %}" class="sidebar-link">ğŸ§  Module 3 â€“ Intelligence</a>
        <a href="{% url 'settings' %}" class="sidebar-link">âš™ï¸ Settings</a>
      </nav>
    </aside>

    <main class="dashboard-main">
      <section class="welcome-card">
        <div>
          <h1>Welcome, {{ user.first_name|default:user.username }} ğŸ‘‹</h1>
          <p>APTIFY evaluates understanding, thinking, and execution.</p>
        </div>
      </section>

      <section class="snapshot-grid" id="dashboard-snapshots">
        <article class="snapshot-card">
          <div class="snapshot-header">
            <span class="snapshot-icon">ğŸ“˜</span>
            <span>Concept Understanding</span>
          </div>
          <div class="snapshot-metric">
            <span>Quiz Score</span>
            <strong id="metric-concept">â€”</strong>
          </div>
          <p class="snapshot-note" id="note-concept">Loadingâ€¦</p>
        </article>
        <article class="snapshot-card">
          <div class="snapshot-header">
            <span class="snapshot-icon">ğŸ§ </span>
            <span>Logical Reasoning</span>
          </div>
          <div class="snapshot-metric">
            <span>Output Guessing</span>
            <strong id="metric-logic">â€”</strong>
          </div>
          <p class="snapshot-note" id="note-logic">Loadingâ€¦</p>
        </article>
        <article class="snapshot-card">
          <div class="snapshot-header">
            <span class="snapshot-icon">âš™ï¸</span>
            <span>Execution Ability</span>
          </div>
          <div class="snapshot-metric">
            <span>Problem Solving</span>
            <strong id="metric-execution">â€”</strong>
          </div>
          <p class="snapshot-note" id="note-execution">Loadingâ€¦</p>
        </article>
      </section>

      <section class="insight-card" id="dashboard-insight">
        <div class="insight-header">
          <h2>ğŸ§  AI Learning Insight</h2>
          <p id="insight-text">Loading insightâ€¦</p>
        </div>
        <div class="chip-group" id="insight-chips"></div>
      </section>

      <section class="flow-card" id="dashboard-flow">
        <h3>Performance Flow</h3>
        <div class="flow-row">
          <div class="flow-step">
            <span>Concept</span>
            <strong id="flow-concept">â€”</strong>
            <div class="flow-bar"><span id="bar-concept" style="width: 0%"></span></div>
          </div>
          <div class="flow-step">
            <span>Logic</span>
            <strong id="flow-logic">â€”</strong>
            <div class="flow-bar"><span id="bar-logic" style="width: 0%"></span></div>
          </div>
          <div class="flow-step">
            <span>Execution</span>
            <strong id="flow-execution">â€”</strong>
            <div class="flow-bar"><span id="bar-execution" style="width: 0%"></span></div>
          </div>
        </div>
      </section>

      <section class="dashboard-actions">
        <a class="btn btn-primary" href="/assignments/">ğŸ” Take New Assignment</a>
        <a class="btn btn-secondary" href="{% url 'intelligence' %}">ğŸ“˜ View Detailed Report</a>
      </section>
    </main>
  </div>
</div>

<script>
(function() {
  const API = { base: '/api', credentials: 'same-origin' };
  function set(id, text) { var el = document.getElementById(id); if (el) el.textContent = text; }
  function setBar(id, pct) {
    var el = document.getElementById(id);
    if (el) { el.style.width = (pct || 0) + '%'; }
  }

  function noteFor(score) {
    if (score == null) return 'â€”';
    if (score >= 70) return 'Strong';
    if (score >= 50) return 'Needs Practice';
    return 'Needs Reinforcement';
  }

  function renderScores(attempt) {
    var c = attempt ? Math.round(attempt.concept_score) : null;
    var l = attempt ? Math.round(attempt.logic_score) : null;
    var e = attempt ? Math.round(attempt.execution_score) : null;
    set('metric-concept', c != null ? c + '%' : 'â€”');
    set('metric-logic', l != null ? l + '%' : 'â€”');
    set('metric-execution', e != null ? e + '%' : 'â€”');
    set('note-concept', noteFor(c));
    set('note-logic', noteFor(l));
    set('note-execution', noteFor(e));
    set('flow-concept', c != null ? c + '%' : 'â€”');
    set('flow-logic', l != null ? l + '%' : 'â€”');
    set('flow-execution', e != null ? e + '%' : 'â€”');
    setBar('bar-concept', c);
    setBar('bar-logic', l);
    setBar('bar-execution', e);
  }

  function renderInsight(report) {
    var p = document.getElementById('insight-text');
    var chips = document.getElementById('insight-chips');
    if (!report) {
      if (p) p.textContent = 'Complete an assignment and generate a report to see your AI learning insight.';
      if (chips) chips.innerHTML = '';
      return;
    }
    if (p) p.textContent = report.recommendation || 'No recommendation yet.';
    if (chips) {
      var html = '';
      if (report.primary_gap) html += '<span class="chip">Primary: ' + escapeHtml(report.primary_gap) + '</span>';
      if (report.secondary_gap) html += '<span class="chip">Secondary: ' + escapeHtml(report.secondary_gap) + '</span>';
      chips.innerHTML = html || '<span class="chip">No gaps identified yet.</span>';
    }
  }
  function escapeHtml(s) {
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  Promise.all([
    fetch(API.base + '/assignments/attempts', { credentials: API.credentials }).then(r => r.ok ? r.json() : []).catch(function() { return []; }),
    fetch(API.base + '/analysis/reports', { credentials: API.credentials }).then(r => r.ok ? r.json() : []).catch(function() { return []; })
  ]).then(function(res) {
    var attempts = res[0] || [];
    var reports = res[1] || [];
    var latest = attempts[0] || null;
    var latestReport = reports[0] || null;
    renderScores(latest);
    renderInsight(latestReport);
  });
})();
</script>
{% endblock %}
