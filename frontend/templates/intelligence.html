{% extends "base.html" %}
{% load static %}

{% block title %}Module 3 - Intelligence | AptiFy{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <header class="topbar">
    <div class="topbar-left">
      <a class="brand" href="/" aria-label="AptiFy home">
        <img src="{% static 'img/aptify-logo.jpg' %}" alt="AptiFy logo" width="32" height="32">
        <span>AptiFy</span>
      </a>
    </div>
    <div class="topbar-right">
      <button class="icon-button" type="button" aria-label="Notifications">ğŸ””</button>
      <div class="avatar" aria-hidden="true">{{ user.first_name|default:user.username|slice:":1" }}</div>
      <form method="post" action="{% url 'account_logout' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary btn-small">Logout</button>
      </form>
    </div>
  </header>

  <div class="dashboard-layout">
    <aside class="sidebar">
      <nav class="sidebar-nav" aria-label="Primary">
        <a href="{% url 'dashboard' %}" class="sidebar-link">ğŸ  Dashboard</a>
        <a href="{% url 'profile' %}" class="sidebar-link">ğŸ“˜ Module 1 â€“ Profile</a>
        <a href="/assignments/" class="sidebar-link">ğŸ§ª Module 2 â€“ Assignment</a>
        <a href="{% url 'intelligence' %}" class="sidebar-link active">ğŸ§  Module 3 â€“ Intelligence</a>
        <a href="{% url 'settings' %}" class="sidebar-link">âš™ï¸ Settings</a>
      </nav>
    </aside>

    <main class="dashboard-main">
      <section class="welcome-card">
        <h1>Intelligence Summary</h1>
        <p>AI insight based on your Module 2 performance data.</p>
      </section>

      <section class="snapshot-grid" id="intel-snapshots">
        <article class="snapshot-card">
          <div class="snapshot-header">
            <span class="snapshot-icon">ğŸ“˜</span>
            <span>Theory Strength</span>
          </div>
          <p class="snapshot-note" id="intel-concept">Loadingâ€¦</p>
        </article>
        <article class="snapshot-card">
          <div class="snapshot-header">
            <span class="snapshot-icon">ğŸ§ </span>
            <span>Logic Strength</span>
          </div>
          <p class="snapshot-note" id="intel-logic">Loadingâ€¦</p>
        </article>
        <article class="snapshot-card">
          <div class="snapshot-header">
            <span class="snapshot-icon">âš™ï¸</span>
            <span>Execution Strength</span>
          </div>
          <p class="snapshot-note" id="intel-execution">Loadingâ€¦</p>
        </article>
      </section>

      <section class="insight-card" id="intel-insight">
        <h2>AI Explanation</h2>
        <p id="intel-recommendation">Loadingâ€¦</p>
      </section>

      <section class="flow-card" id="intel-gaps">
        <h3>Detected Gaps</h3>
        <div class="chip-group" id="intel-chips"></div>
        <p class="text-muted" id="intel-empty" style="display:none;">Complete an assignment and generate an intelligence report to see detected gaps.</p>
      </section>

      <section class="insight-card" id="intel-reports-list" style="display:none;">
        <h2>Your Reports</h2>
        <ul id="intel-reports-ul"></ul>
      </section>
    </main>
  </div>
</div>

<script>
(function() {
  var API = { base: '/api', credentials: 'same-origin' };
  function set(id, text) { var el = document.getElementById(id); if (el) el.textContent = text; }
  function show(id, on) { var el = document.getElementById(id); if (el) el.style.display = on ? '' : 'none'; }
  function strengthNote(score) {
    if (score == null) return 'â€”';
    if (score >= 70) return 'Strong';
    if (score >= 50) return 'Developing';
    return 'Needs reinforcement';
  }

  Promise.all([
    fetch(API.base + '/analysis/reports', { credentials: API.credentials }).then(function(r) { return r.ok ? r.json() : []; }).catch(function() { return []; }),
    fetch(API.base + '/assignments/attempts', { credentials: API.credentials }).then(function(r) { return r.ok ? r.json() : []; }).catch(function() { return []; })
  ]).then(function(res) {
    var reports = res[0] || [];
    var attempts = res[1] || [];
    var r = reports[0] || null;
    var latestAttempt = attempts[0] || null;

    if (latestAttempt) {
      set('intel-concept', strengthNote(latestAttempt.concept_score));
      set('intel-logic', strengthNote(latestAttempt.logic_score));
      set('intel-execution', strengthNote(latestAttempt.execution_score));
    } else {
      set('intel-concept', 'â€”');
      set('intel-logic', 'â€”');
      set('intel-execution', 'â€”');
    }

    if (!r) {
      set('intel-recommendation', 'Complete an assignment and generate an intelligence report to see your AI explanation.');
      show('intel-empty', true);
      document.getElementById('intel-chips').innerHTML = '';
      return;
    }
    set('intel-recommendation', r.recommendation || 'â€”');
    var chips = document.getElementById('intel-chips');
    chips.innerHTML = '';
    if (r.primary_gap) {
      var s = document.createElement('span'); s.className = 'chip'; s.textContent = 'Primary: ' + r.primary_gap; chips.appendChild(s);
    }
    if (r.secondary_gap) {
      var s2 = document.createElement('span'); s2.className = 'chip'; s2.textContent = 'Secondary: ' + r.secondary_gap; chips.appendChild(s2);
    }
    show('intel-empty', false);
    if (reports.length > 1) {
      show('intel-reports-list', true);
      var ul = document.getElementById('intel-reports-ul');
      reports.slice(0, 5).forEach(function(rep) {
        var li = document.createElement('li');
        var a = document.createElement('a');
        a.href = '/analysis/report/' + rep.attempt_id + '/';
        a.textContent = 'Report (attempt ' + rep.attempt_id + ') â€“ ' + rep.primary_gap + ' â€“ ' + rep.generated_at;
        li.appendChild(a);
        ul.appendChild(li);
      });
    }
  });
})();
</script>
{% endblock %}
